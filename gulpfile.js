// gulpfile.js (ESM ë²„ì „)
// Node 14+ / gulp 4+ í˜¸í™˜

import { series, watch } from 'gulp';
import * as glob from 'glob';
import path from 'path';
import fs from 'fs';
import { fileURLToPath } from 'url';
import { deleteAsync } from 'del';

// âœ… ESM í™˜ê²½ì—ì„œ __dirname, __filename ëŒ€ì²´
const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);

// -----------------------------
// ì„¤ì •
// -----------------------------
const PAGES_DIR = path.join(__dirname, 'pages');
const OUT_INDEX = path.join(PAGES_DIR, 'index.html');
const HTML_GLOB = path.join(PAGES_DIR, '*/*.html');

// -----------------------------
// ì¸ë±ìŠ¤ íŒŒì¼ ìƒì„±
// -----------------------------
function generateIndex(done) {
  const files = glob.sync(HTML_GLOB, { nodir: true });

  const groups = {};
  files.forEach((fullPath) => {
    const dir = path.dirname(fullPath);
    const category = path.basename(dir);
    const fileName = path.basename(fullPath);
    const relPath = './' + path.relative(PAGES_DIR, fullPath).replace(/\\/g, '/');
    if (!groups[category]) groups[category] = [];
    groups[category].push({ name: fileName, relPath });
  });

  const now = new Date();
  const header = `<!-- Generated by gulp buildIndex on ${now.toLocaleString()} -->\n`;
  let html = `<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>STICH íŒŒì¼ ëª©ë¡</title>
  <style>
    body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Noto Sans KR", "Apple SD Gothic Neo", sans-serif; padding: 24px; line-height:1.6; }
    h1 { margin-bottom: 8px; }
    .category { margin-bottom: 18px; }
    .category h2 { margin: 8px 0; font-size: 1.05rem; }
    ul { margin: 6px 0 12px 20px; }
    li {list-style: none;}
    a { text-decoration: none; }
    a:hover { text-decoration: underline; }
    .meta { color: #666; font-size: 0.9rem; margin-bottom: 18px; }
    .no-files { color: #b00; }
  </style>
</head>
<body>
  ${header}
  <h1>STICH HTML íŒŒì¼ ëª©ë¡</h1>
  <div class="meta">ìƒì„±ì¼: ${now.toLocaleString()}</div>
`;

  const categoryNames = Object.keys(groups).sort();
  if (categoryNames.length === 0) {
    html += `<p class="no-files">ê²€ìƒ‰ëœ íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤. (ê²½ë¡œ: ${HTML_GLOB})</p>\n`;
  } else {
    categoryNames.forEach((cat) => {
      html += `<section class="category">\n  <h2>${cat} <small>(${groups[cat].length})</small></h2>\n  <ul>\n`;
      groups[cat]
        .sort((a, b) => a.name.localeCompare(b.name, 'ko'))
        .forEach((f) => {
          html += `    <li><a href="${f.relPath}" target="_blank" rel="noopener noreferrer">${f.name}</a></li>\n`;
        });
      html += `  </ul>\n</section>\n`;
    });
  }

  html += `
  <footer style="margin-top:30px;color:#888;font-size:0.9rem">
  </footer>
</body>
</html>`;

  fs.writeFileSync(OUT_INDEX, html, 'utf8');
  console.log(`âœ… Index generated: ${OUT_INDEX} (${files.length} files)`);

  done();
}

// -----------------------------
// ê¸°ì¡´ index.html ì‚­ì œ
// -----------------------------
async function cleanIndex() {
  await deleteAsync([OUT_INDEX]);
  console.log('ğŸ§¹ Old index.html deleted.');
}

// -----------------------------
// ë³€ê²½ ê°ì§€
// -----------------------------
export function watchIndex() {
  const watchGlob = path.join(PAGES_DIR, '**/*.html');
  const watcher = watch(watchGlob, { ignoreInitial: false }, generateIndex);
  console.log(`ğŸ‘€ Watching: ${watchGlob}`);
  return watcher;
}

// -----------------------------
// ê¸°ë³¸ task
// -----------------------------
export const buildIndex = series(cleanIndex, generateIndex);
export default buildIndex;
